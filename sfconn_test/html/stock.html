<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ê°€ íë¦„ ê·¸ë˜í”„ (Chart.js)</title>
    
    <!-- Chart.js ë° ê´€ë ¨ í”ŒëŸ¬ê·¸ì¸ (Candlestick, Luxon time adapter) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>

    <style>
        :root {
            --up-color: #f23645; /* ìƒìŠ¹ë´‰ ìƒ‰ìƒ (ë¹¨ê°•) */
            --down-color: #2962ff; /* í•˜ë½ë´‰ ìƒ‰ìƒ (íŒŒë‘) */
            --border-color: #e0e3eb;
            --bg-color: #ffffff;
            --text-color: #333333;
            --text-muted: #787b86;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f5f7;
            margin: 0;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
        }

        .chart-card {
            background-color: var(--bg-color);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            width: 100%;
            max-width: 900px;
            padding: 24px;
            box-sizing: border-box;
        }

        /* ì»¨íŠ¸ë¡¤ ë° íˆ´ë°” ì˜ì—­ */
        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .timeframes {
            display: flex;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
        }

        .timeframes .tf-item {
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .timeframes .tf-item.active {
            background-color: #f0f3fa;
            color: #131722;
            font-weight: 600;
        }

        .timeframes .tf-item:hover:not(.active) {
            background-color: #f8f9fd;
            color: #131722;
        }

        .toolbar-icons {
            display: flex;
            gap: 16px;
            color: var(--text-muted);
            font-size: 16px;
            cursor: pointer;
        }

        .toolbar-icons span {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 6px;
        }

        .toolbar-icons span:hover {
            background-color: #f0f3fa;
            color: #131722;
        }

        /* ì°¨íŠ¸ ìƒë‹¨ ì •ë³´ ë° ë²”ë¡€ */
        .chart-header {
            margin-bottom: 12px;
        }

        .chart-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .ohlc-info {
            font-size: 13px;
            font-weight: 400;
            display: flex;
            gap: 10px;
            color: var(--text-color);
        }

        .ohlc-info b { font-weight: 600; }

        .chart-price-info {
            color: var(--up-color);
            font-weight: 500;
            margin-left: auto; /* Push to the right if there's space */
        }

        .legend {
            font-size: 12px;
            color: var(--text-color);
            display: flex;
            gap: 12px;
            margin-top: 8px;
            align-items: center;
        }

        .legend-title {
            color: var(--text-muted);
        }

        .ma-value { font-weight: 600; }
        .ma-5 { color: #2ecc71; }
        .ma-20 { color: #e74c3c; }
        .ma-60 { color: #f39c12; }
        .ma-120 { color: #9b59b6; }

        /* Chart.js ìº”ë²„ìŠ¤ ë˜í¼ ì˜ì—­ */
        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 500px;
        }

        @media (max-width: 600px) {
            .toolbar {
                flex-direction: column;
                align-items: flex-start;
            }
            .chart-wrapper {
                height: 400px;
            }
        }
    </style>
</head>
<body>

    <div class="chart-card">
        <!-- ìƒë‹¨ íˆ´ë°” -->
        <div class="toolbar">
            <div class="timeframes">
                <div class="tf-item" data-tf="1m">1ë¶„</div>
                <div class="tf-item active" data-tf="1d">ì¼</div>
                <div class="tf-item" data-tf="1w">ì£¼</div>
                <div class="tf-item" data-tf="1M">ì›”</div>
                <div class="tf-item" data-tf="1y">ë…„</div>
            </div>
            <div class="toolbar-icons">
                <span>ğŸ“Š</span>
                <span>ğŸ—‘ï¸</span>
                <span>âš™ï¸</span>
                <span>â•</span>
                <span>ğŸ“‰</span>
                <span>â¤¢</span>
            </div>
        </div>

        <!-- ì£¼ê°€ ì •ë³´ ë° ì´ë™í‰ê· ì„  ë²”ë¡€ -->
        <div class="chart-header">
            <div class="chart-title">
                <span id="date-info" style="color: var(--text-muted); font-size: 13px;"></span>
                <div class="ohlc-info">
                    <span>ì‹œê°€ <b id="open-val">0</b></span>
                    <span>ê³ ê°€ <b id="high-val" style="color: var(--up-color)">0</b></span>
                    <span>ì €ê°€ <b id="low-val" style="color: var(--down-color)">0</b></span>
                    <span>ì¢…ê°€ <b id="close-val">0</b></span>
                </div>
                <span class="chart-price-info" id="current-price-info">0ì›</span>
            </div>
            <div class="legend">
                <span class="legend-title">ì´ë™í‰ê· ì„ </span>
                <span class="ma-value ma-5" id="ma5-val">5</span>
                <span class="ma-value ma-20" id="ma20-val">20</span>
                <span class="ma-value ma-60" id="ma60-val">60</span>
                <span class="ma-value ma-120" id="ma120-val">120</span>
            </div>
        </div>

        <!-- Chart.js ìº”ë²„ìŠ¤ êµ¬ì—­ -->
        <div class="chart-wrapper">
            <canvas id="tvchart"></canvas>
        </div>
    </div>

    <script>
        // DOM ìš”ì†Œ ìºì‹±
        const priceInfoEl = document.getElementById('current-price-info');
        const dateInfoEl = document.getElementById('date-info');
        const openValEl = document.getElementById('open-val');
        const highValEl = document.getElementById('high-val');
        const lowValEl = document.getElementById('low-val');
        const closeValEl = document.getElementById('close-val');

        // ì „ì—­ ìƒíƒœ
        let currentTf = '1d';
        let priceData = [];
        let volumeData = [];
        let volumeColors = [];
        let ma5Data = [], ma20Data = [], ma60Data = [], ma120Data = [];

        // 1. ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜
        function generateData(tf) {
            const pData = [];
            const vData = [];
            const vColors = [];
            
            let currentPrice = 90000;
            let date = luxon.DateTime.fromISO('2025-06-01');

            for (let i = 0; i < 200; i++) {
                if (tf === '1m') {
                    date = date.plus({ minutes: 1 });
                } else if (tf === '1d') {
                    do { date = date.plus({ days: 1 }); } while (date.weekday === 6 || date.weekday === 7);
                } else if (tf === '1w') {
                    date = date.plus({ weeks: 1 });
                } else if (tf === '1M') {
                    date = date.plus({ months: 1 });
                } else if (tf === '1y') {
                    date = date.plus({ years: 1 });
                }

                const time = date.valueOf();
                // ì§§ì€ ìŠ¤ì¼€ì¼ì€ ê°€ê²© ë³€ë™ì„±ì„ ì‘ê²Œ ì„¤ì •
                const volatility = currentPrice * (tf === '1m' ? 0.005 : 0.05); 
                
                const direction = (Math.random() > 0.45) ? 1 : -1; 
                let trend = direction * Math.random() * volatility;
                
                // ë¶„ë´‰ ì°¨íŠ¸ë¥¼ ì œì™¸í•˜ê³ ëŠ” ì¡°ê¸ˆì”© ìš°ìƒí–¥ ì‹œë®¬ë ˆì´ì…˜
                if (currentPrice < 190000 && tf !== '1m') trend += 500; 

                const open = currentPrice + (Math.random() - 0.5) * (volatility * 0.2);
                const close = open + trend;
                const high = Math.max(open, close) + Math.random() * volatility * 0.5;
                const low = Math.min(open, close) - Math.random() * volatility * 0.5;

                currentPrice = close;
                const volume = Math.floor(Math.random() * 80000000) + 20000000;

                pData.push({ x: time, o: open, h: high, l: low, c: close });
                vData.push({ x: time, y: volume });
                vColors.push(close >= open ? 'rgba(242, 54, 69, 0.7)' : 'rgba(41, 98, 255, 0.7)');
            }
            return { pData, vData, vColors };
        }

        // 2. ì´ë™í‰ê· ì„ (MA) ê³„ì‚°
        function calculateSMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push({ x: data[i].x, y: null });
                    continue;
                }
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].c;
                }
                result.push({ x: data[i].x, y: sum / period });
            }
            return result;
        }

        function refreshData(tf) {
            currentTf = tf;
            const generated = generateData(tf);
            priceData = generated.pData;
            volumeData = generated.vData;
            volumeColors = generated.vColors;

            ma5Data = calculateSMA(priceData, 5);
            ma20Data = calculateSMA(priceData, 20);
            ma60Data = calculateSMA(priceData, 60);
            ma120Data = calculateSMA(priceData, 120);
        }

        // ì²˜ìŒ 1íšŒ ë°ì´í„° ìƒì„±
        refreshData('1d');

        // 3. UI ë° íˆ´íŒ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateHeader(index) {
            const dataObj = priceData[index];
            if (!dataObj) return;

            // ì „ì¼ ë°ì´í„°ê°€ ìˆë‹¤ë©´ ëŒ€ë¹„ í¼ì„¼íŠ¸ êµ¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©, ì—†ë‹¤ë©´ ì‹œê°€ ê¸°ì¤€
            const prevClose = priceData[index - 1] ? priceData[index - 1].c : dataObj.o;
            const diff = dataObj.c - prevClose; 
            const diffPercent = ((diff / prevClose) * 100).toFixed(2);
            
            const closeStr = Math.round(dataObj.c).toLocaleString() + 'ì›';
            const sign = diff > 0 ? '+' : '';
            const color = diff >= 0 ? 'var(--up-color)' : 'var(--down-color)';
            
            priceInfoEl.textContent = `${closeStr} (${sign}${diffPercent}%)`;
            priceInfoEl.style.color = color;

            const format = currentTf === '1m' ? 'yyyy-MM-dd HH:mm' : 'yyyy-MM-dd';
            dateInfoEl.textContent = luxon.DateTime.fromMillis(dataObj.x).toFormat(format);
            
            openValEl.textContent = Math.round(dataObj.o).toLocaleString();
            highValEl.textContent = Math.round(dataObj.h).toLocaleString();
            lowValEl.textContent = Math.round(dataObj.l).toLocaleString();
            closeValEl.textContent = Math.round(dataObj.c).toLocaleString();

            closeValEl.style.color = color;

            const maSet = [
                { id: 'ma5-val', data: ma5Data, period: 5 },
                { id: 'ma20-val', data: ma20Data, period: 20 },
                { id: 'ma60-val', data: ma60Data, period: 60 },
                { id: 'ma120-val', data: ma120Data, period: 120 }
            ];

            maSet.forEach(ma => {
                const val = ma.data[index]?.y;
                document.getElementById(ma.id).textContent = val ? Math.round(val).toLocaleString() : ma.period;
            });
        }

        // 4. Chart.js ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™”
        const ctx = document.getElementById('tvchart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'candlestick', 
            data: {
                datasets: [
                    {
                        label: 'Price',
                        data: priceData,
                        yAxisID: 'y',
                        color: { up: '#f23645', down: '#2962ff', unchanged: '#999' },
                        borderColor: { up: '#f23645', down: '#2962ff', unchanged: '#999' },
                    },
                    { type: 'line', label: 'MA 5', data: ma5Data, borderColor: '#2ecc71', borderWidth: 1.5, pointRadius: 0, yAxisID: 'y', tension: 0.2 },
                    { type: 'line', label: 'MA 20', data: ma20Data, borderColor: '#e74c3c', borderWidth: 1.5, pointRadius: 0, yAxisID: 'y', tension: 0.2 },
                    { type: 'line', label: 'MA 60', data: ma60Data, borderColor: '#f39c12', borderWidth: 1.5, pointRadius: 0, yAxisID: 'y', tension: 0.2 },
                    { type: 'line', label: 'MA 120', data: ma120Data, borderColor: '#9b59b6', borderWidth: 1.5, pointRadius: 0, yAxisID: 'y', tension: 0.2 },
                    {
                        type: 'bar', label: 'Volume', data: volumeData,
                        backgroundColor: volumeColors, yAxisID: 'volume',
                        barPercentage: 0.8, categoryPercentage: 0.8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                onHover: (event, activeElements) => {
                    if (activeElements.length > 0) {
                        updateHeader(activeElements[0].index);
                    } else {
                        updateHeader(priceData.length - 1);
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                scales: {
                    x: {
                        type: 'timeseries',
                        time: {
                            unit: 'day',
                            tooltipFormat: 'yyyy-MM-dd'
                        },
                        grid: { display: true, color: '#e0e3eb' },
                        ticks: { maxTicksLimit: 10 }
                    },
                    y: {
                        position: 'right',
                        grid: { display: true, color: '#e0e3eb' }
                    },
                    volume: {
                        type: 'linear', position: 'right', display: false, min: 0
                    }
                }
            }
        });

        // ì°¨íŠ¸ ìŠ¤ì¼€ì¼ ë° ë Œë”ë§ì„ ì—…ë°ì´íŠ¸ í•˜ëŠ” í•¨ìˆ˜
        function applyChartUpdate() {
            chart.data.datasets[0].data = priceData;
            chart.data.datasets[1].data = ma5Data;
            chart.data.datasets[2].data = ma20Data;
            chart.data.datasets[3].data = ma60Data;
            chart.data.datasets[4].data = ma120Data;
            chart.data.datasets[5].data = volumeData;
            chart.data.datasets[5].backgroundColor = volumeColors;

            let unit = 'day';
            let tFormat = 'yyyy-MM-dd';
            if (currentTf === '1m') { unit = 'minute'; tFormat = 'yyyy-MM-dd HH:mm'; }
            else if (currentTf === '1w') { unit = 'week'; }
            else if (currentTf === '1M') { unit = 'month'; }
            else if (currentTf === '1y') { unit = 'year'; }

            chart.options.scales.x.time.unit = unit;
            chart.options.scales.x.time.tooltipFormat = tFormat;
            
            // maxVolume ì¬ê³„ì‚° (ë¹„ì–´ìˆìœ¼ë©´ 0 ì²˜ë¦¬)
            const maxVolume = volumeData.length > 0 ? Math.max(...volumeData.map(v => v.y)) : 0;
            // ê±°ë˜ëŸ‰ ë§‰ëŒ€ê°€ í•˜ë‹¨ 25%ë§Œ ì±„ìš°ë„ë¡ ìµœëŒ€ê°’ 4ë°° íŠ¸ë¦­ ì ìš©
            chart.options.scales.volume.max = maxVolume * 4;

            chart.update();
            updateHeader(priceData.length - 1);
        }
        
        // 5. ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
        const tfButtons = document.querySelectorAll('.tf-item');
        tfButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                // í™œì„±í™” ìŠ¤íƒ€ì¼(ë°°ê²½ìƒ‰) ë³€ê²½
                tfButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // ë°ì´í„° ì¬ê°€ê³µ ë° UI ì ìš©
                const targetTf = btn.getAttribute('data-tf');
                refreshData(targetTf);
                applyChartUpdate();
            });
        });

        // ë¡œë“œ ì§í›„ ì´ˆê¸° íŠ¸ë¦­(ë³¼ë¥¨ìŠ¤ì¼€ì¼) ë° UI ì„¸íŒ… ì™„ë£Œ
        applyChartUpdate();
    </script>
</body>
</html>
